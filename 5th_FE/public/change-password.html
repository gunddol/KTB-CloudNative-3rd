<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>비밀번호 수정</title>
  <link rel="stylesheet" href="/css/style.css"/>
</head>
<body>
  <div class="wrap">
    <!-- 뒤로가기 버튼 -->
    <button class="back-button" onclick="history.back()">←</button>
    
    <!-- 메인 컨텐츠 -->
    <div class="contents">
      <div class="change-password-container">
        <h1 class="change-password-title">비밀번호 수정</h1>
        
        <div class="password-form-card">
          <div class="form-group">
            <label class="form-label">현재 비밀번호</label>
            <input type="password" id="currentPassword" class="form-input" placeholder="현재 비밀번호를 입력하세요"/>
          </div>
          
          <div class="form-group">
            <label class="form-label">새 비밀번호</label>
            <input type="password" id="newPassword" class="form-input" placeholder="새 비밀번호를 입력하세요"/>
            <div class="helper-text">8자 이상, 영문, 숫자, 특수문자 포함</div>
          </div>
          
          <div class="form-group">
            <label class="form-label">새 비밀번호 확인</label>
            <input type="password" id="confirmPassword" class="form-input" placeholder="새 비밀번호를 다시 입력하세요"/>
          </div>
          
          <button id="btnChangePassword" class="update-button">비밀번호 변경</button>
        </div>
      </div>
    </div>
  </div>
  
  <script src="/js/auth.js"></script>
  <script src="/js/aside.js"></script>
  <script src="/js/ui.js"></script>
  <script src="/js/api.js"></script>
  <script>
    renderHeader();
    if(!requireLogin('/login')){}
    
    // 현재 사용자 정보 로드
    const currentUser = Auth.profile();
    const userId = Auth.userId();
    
    // 프로필 이미지 설정
    if(currentUser?.imageUrl) {
      document.querySelector('.profile_circle').src = currentUser.imageUrl;
    }
    
    // 비밀번호 유효성 검사 함수
    function validatePassword(password) {
      const minLength = 8;
      const hasUpperCase = /[A-Z]/.test(password);
      const hasLowerCase = /[a-z]/.test(password);
      const hasNumbers = /\d/.test(password);
      const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);
      
      return {
        isValid: password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers && hasSpecialChar,
        errors: [
          password.length < minLength ? `최소 ${minLength}자 이상` : null,
          !hasUpperCase ? '대문자 포함' : null,
          !hasLowerCase ? '소문자 포함' : null,
          !hasNumbers ? '숫자 포함' : null,
          !hasSpecialChar ? '특수문자 포함' : null
        ].filter(Boolean)
      };
    }
    
    // 비밀번호 변경 버튼 클릭 이벤트
    document.getElementById('btnChangePassword').addEventListener('click', async () => {
      const currentPassword = document.getElementById('currentPassword').value.trim();
      const newPassword = document.getElementById('newPassword').value.trim();
      const confirmPassword = document.getElementById('confirmPassword').value.trim();
      
      // 입력값 검증
      if (!currentPassword) {
        alert('현재 비밀번호를 입력해주세요.');
        document.getElementById('currentPassword').focus();
        return;
      }
      
      if (!newPassword) {
        alert('새 비밀번호를 입력해주세요.');
        document.getElementById('newPassword').focus();
        return;
      }
      
      if (!confirmPassword) {
        alert('새 비밀번호 확인을 입력해주세요.');
        document.getElementById('confirmPassword').focus();
        return;
      }
      
      if (newPassword !== confirmPassword) {
        alert('새 비밀번호가 일치하지 않습니다.');
        document.getElementById('confirmPassword').focus();
        return;
      }
      
      if (currentPassword === newPassword) {
        alert('현재 비밀번호와 새 비밀번호가 같습니다.');
        document.getElementById('newPassword').focus();
        return;
      }
      
      // 새 비밀번호 유효성 검사
      const passwordValidation = validatePassword(newPassword);
      if (!passwordValidation.isValid) {
        alert('새 비밀번호는 다음 조건을 만족해야 합니다:\n' + passwordValidation.errors.join(', '));
        document.getElementById('newPassword').focus();
        return;
      }
      
      // 버튼 비활성화 및 로딩 상태
      const btnChangePassword = document.getElementById('btnChangePassword');
      btnChangePassword.disabled = true;
      btnChangePassword.textContent = '변경 중...';
      
      try {
        // 백엔드 API 호출로 비밀번호 변경
        const response = await apiFetch('/users/change-password', {
          method: 'PUT',
          body: JSON.stringify({ 
            currentPassword: currentPassword,
            newPassword: newPassword
          })
        });
        
        alert('비밀번호가 성공적으로 변경되었습니다.');
        
        // 폼 초기화
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        
        // 프로필 페이지로 이동
        location.href = '/profile.html';
        
      } catch (error) {
        console.error('비밀번호 변경 실패:', error);
        const errorMessage = error.message || '비밀번호 변경에 실패했습니다.';
        alert(errorMessage);
      } finally {
        // 버튼 상태 복원
        btnChangePassword.disabled = false;
        btnChangePassword.textContent = '비밀번호 변경';
      }
    });
  </script>
</body>
</html>
